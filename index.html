<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Masters AI - Fast AI</title>
    
    <link rel="icon" href="ChessAI%20Icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0f2847 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 80px;
        }

        .auth-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a1a, #1a1a3e);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-modal {
            background: linear-gradient(145deg, #1a1a2e, #0d0d1a);
            padding: 35px;
            border-radius: 20px;
            border: 2px solid #e94560;
            max-width: 400px;
            width: 95%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(233, 69, 96, 0.3);
        }

        .auth-logo { 
            width: 90px;
            height: 90px;
            margin: 0 auto 15px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .auth-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 8px rgba(233, 69, 96, 0.4));
        }

        .auth-title { color: #e94560; font-size: 2em; margin-bottom: 8px; }
        .auth-subtitle { color: #888; margin-bottom: 20px; font-size: 0.9em; }

        .social-btn {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            border: none;
            border-radius: 50px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .google-btn { background: #fff; color: #333; }
        .facebook-btn { background: #1877f2; color: white; }
        .twitter-btn { background: #1da1f2; color: white; }
        .github-btn { background: #333; color: white; }
        .social-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }

        .divider {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: #555;
            font-size: 0.85em;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #444;
        }
        .divider span { padding: 0 12px; }

        .guest-input {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #333;
            border-radius: 50px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 1em;
            margin-bottom: 10px;
        }
        .guest-input:focus { outline: none; border-color: #e94560; }
        .guest-input::placeholder { color: #666; }

        .play-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e94560, #ff6b9d);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        .play-btn:hover { transform: translateY(-2px); }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .user-info { display: flex; align-items: center; gap: 10px; }
        
        .user-avatar {
            width: 45px; 
            height: 45px;
            border-radius: 50%;
            overflow: hidden; 
            border: 2px solid #e94560;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1a1a2e;
            padding: 0;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .user-name { color: white; font-weight: bold; }
        .user-points { color: #4ade80; font-size: 0.8em; }

        .logout-btn {
            padding: 8px 16px;
            background: transparent;
            color: #e94560;
            border: 2px solid #e94560;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        .logout-btn:hover { background: #e94560; color: white; }

        .main-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 1300px;
            margin: 0 auto;
        }

        .game-section { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .title-section h1 { color: #e94560; font-size: 1.8em; text-align: center; }
        .subtitle { color: #777; text-align: center; font-size: 0.85em; }

        .difficulty-bar { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        .diff-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        .diff-btn:hover { opacity: 1; transform: scale(1.05); }
        .diff-btn.active { opacity: 1; transform: scale(1.08); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .diff-btn.easy { background: linear-gradient(135deg, #4ade80, #22c55e); color: white; }
        .diff-btn.medium { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
        .diff-btn.hard { background: linear-gradient(135deg, #f87171, #dc2626); color: white; }
        .diff-btn.master { background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; }
        .diff-btn.gm { background: linear-gradient(135deg, #ec4899, #be185d); color: white; }

        .mode-indicator {
            text-align: center;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .mode-indicator.hints-on { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .mode-indicator.hints-off { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 55px);
            grid-template-rows: repeat(8, 55px);
            border: 4px solid #e94560;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        }

        .square {
            width: 55px; height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.15s ease;
        }
        .square.light { background: linear-gradient(135deg, #f0d9b5, #e8c99b); }
        .square.dark { background: linear-gradient(135deg, #b58863, #996644); }
        .square.selected { background: linear-gradient(135deg, #7dd87d, #4ade80) !important; }
        .square.valid-move::after {
            content: '';
            position: absolute;
            width: 14px; height: 14px;
            background: rgba(0, 200, 0, 0.6);
            border-radius: 50%;
        }
        .square.valid-capture { background: linear-gradient(135deg, #ff6b6b, #dc2626) !important; }
        .square.last-move { box-shadow: inset 0 0 10px rgba(255, 200, 0, 0.6); }
        .square.in-check { background: linear-gradient(135deg, #ff0000, #aa0000) !important; }
        .square:hover { filter: brightness(1.1); }
        
        .square.wrong-move {
            background: linear-gradient(135deg, #ff0000, #cc0000) !important;
            animation: wrongShake 0.4s ease;
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px) scale(1.05); }
            20%, 40%, 60%, 80% { transform: translateX(3px) scale(1.05); }
        }
        
        .square.wrong-pulse { animation: wrongPulse 0.5s ease; }
        
        @keyframes wrongPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 0, 0, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        .side-panel {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 18px;
            min-width: 260px;
            backdrop-filter: blur(10px);
        }

        .ai-section { text-align: center; margin-bottom: 12px; }
        .ai-avatar {
            width: 70px; height: 70px;
            margin: 0 auto 8px;
            background: linear-gradient(135deg, #e94560, #ff6b9d);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
        }
        .ai-name { color: #e94560; font-size: 1.2em; font-weight: bold; }
        .ai-level { color: #888; font-size: 0.8em; }

        .chat-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 12px;
            min-height: 60px;
            margin: 12px 0;
        }
        .ai-msg { color: #fff; font-size: 0.9em; line-height: 1.4; text-align: center; }

        .thinking {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #e94560;
            font-size: 0.85em;
            margin: 8px 0;
        }
        .thinking.active { display: flex; }
        .dots span {
            display: inline-block;
            width: 6px; height: 6px;
            background: #e94560;
            border-radius: 50%;
            animation: dotBounce 1.4s ease-in-out infinite;
        }
        .dots span:nth-child(2) { animation-delay: 0.2s; }
        .dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotBounce {
            0%, 80%, 100% { transform: scale(0.3); }
            40% { transform: scale(1); }
        }

        .turn-display {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .turn-display.white-turn { background: linear-gradient(135deg, #4ade80, #22c55e); color: white; }
        .turn-display.black-turn { background: linear-gradient(135deg, #e94560, #ff6b9d); color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        .stat-card {
            background: rgba(255,255,255,0.08);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label { color: #888; font-size: 0.7em; }
        .stat-value { color: #fff; font-size: 1.1em; font-weight: bold; }

        .action-btns { display: flex; gap: 6px; }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .new-btn { background: linear-gradient(135deg, #4ade80, #22c55e); color: white; }
        .resign-btn { background: linear-gradient(135deg, #f87171, #dc2626); color: white; }
        .action-btn:hover { transform: translateY(-2px); }

        .captures-section {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .captures-label { color: #888; font-size: 0.75em; margin-bottom: 3px; }
        .captures-pieces { font-size: 1.1em; min-height: 22px; }

        .leaderboard {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 18px;
            min-width: 240px;
            max-width: 280px;
        }
        .lb-header { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .lb-title { color: #fbbf24; font-size: 1.2em; font-weight: bold; }
        .lb-month {
            text-align: center;
            color: #888;
            font-size: 0.75em;
            margin-bottom: 10px;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        .lb-list { display: flex; flex-direction: column; gap: 5px; max-height: 350px; overflow-y: auto; }
        .lb-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .lb-item.me { border: 2px solid #e94560; background: rgba(233, 69, 96, 0.15); }
        .lb-item.gold { background: rgba(255, 215, 0, 0.15); }
        .lb-item.silver { background: rgba(192, 192, 192, 0.15); }
        .lb-item.bronze { background: rgba(205, 127, 50, 0.15); }
        .lb-rank {
            width: 26px; height: 26px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border-radius: 50%;
            margin-right: 8px;
            font-size: 0.8em;
        }
        .lb-rank.r1 { background: linear-gradient(135deg, #ffd700, #ffb700); color: #333; }
        .lb-rank.r2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #333; }
        .lb-rank.r3 { background: linear-gradient(135deg, #cd7f32, #b8860b); color: #fff; }
        .lb-rank.r-other { background: rgba(255,255,255,0.2); color: #fff; }
        .lb-info { flex: 1; }
        .lb-name { color: #fff; font-weight: 600; font-size: 0.85em; }
        .lb-record { color: #888; font-size: 0.7em; }
        .lb-points { color: #4ade80; font-weight: bold; font-size: 0.95em; }
        .no-data { text-align: center; color: #666; padding: 25px; font-size: 0.85em; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: linear-gradient(145deg, #1a1a2e, #0d0d1a);
            padding: 35px;
            border-radius: 18px;
            text-align: center;
            border: 3px solid #e94560;
            max-width: 380px;
            width: 90%;
        }
        .modal-title { font-size: 1.8em; color: #e94560; margin-bottom: 8px; }
        .modal-msg { color: #ccc; font-size: 1em; margin-bottom: 15px; }
        .modal-points {
            background: rgba(74, 222, 128, 0.15);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .modal-points .label { color: #888; font-size: 0.8em; }
        .modal-points .value { color: #4ade80; font-size: 2em; font-weight: bold; }
        .modal-btn {
            padding: 12px 35px;
            background: linear-gradient(135deg, #e94560, #ff6b9d);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn:hover { transform: scale(1.05); }

        .hidden { display: none !important; }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 50%, #0d0d1a 100%);
            border-top: 2px solid #e94560;
            padding: 15px 20px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -5px 30px rgba(233, 69, 96, 0.2);
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .footer-text {
            color: #888;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .footer-text .copyright { color: #e94560; font-weight: bold; }
        .footer-text .author { color: #4ade80; font-weight: 600; font-style: italic; }

        .footer-icon {
            color: #e94560;
            margin: 0 5px;
            animation: heartBeat 1.5s ease infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 1000px) {
            .main-container { flex-direction: column; align-items: center; }
            .leaderboard { width: 100%; max-width: 450px; }
        }
        @media (max-width: 500px) {
            .chess-board { grid-template-columns: repeat(8, 42px); grid-template-rows: repeat(8, 42px); }
            .square { width: 42px; height: 42px; font-size: 30px; }
            .header { flex-direction: column; gap: 8px; }
            .side-panel, .leaderboard { min-width: unset; width: 100%; }
            .footer { padding: 12px 15px; }
            .footer-text { font-size: 0.75em; }
        }
    </style>
</head>
<body>
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <div class="auth-logo">
                <img src="ChessAI%20Icon.png" alt="Chess AI Logo">
            </div>
            <h2 class="auth-title">Chess Masters AI</h2>
            <p class="auth-subtitle">Sign in to compete globally!</p>
            <button class="social-btn google-btn" onclick="socialLogin('google')"><i class="fab fa-google"></i> Google</button>
            <button class="social-btn facebook-btn" onclick="socialLogin('facebook')"><i class="fab fa-facebook-f"></i> Facebook</button>
            <button class="social-btn twitter-btn" onclick="socialLogin('twitter')"><i class="fab fa-twitter"></i> Twitter</button>
            <button class="social-btn github-btn" onclick="socialLogin('github')"><i class="fab fa-github"></i> GitHub</button>
            <div class="divider"><span>or guest</span></div>
            <input type="text" class="guest-input" id="guestName" placeholder="Username" maxlength="12">
            <button class="play-btn" onclick="guestLogin()"><i class="fas fa-play"></i> Play</button>
        </div>
    </div>

    <div id="gameArea" class="hidden">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <img src="ChessAI%20Icon.png" alt="User Avatar">
                </div>
                <div>
                    <div class="user-name" id="userName">Player</div>
                    <div class="user-points">üèÜ <span id="userPoints">0</span> pts</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="main-container">
            <div class="game-section">
                <div class="title-section">
                    <h1>‚ôüÔ∏è Chess Masters AI ‚ôüÔ∏è</h1>
                    <p class="subtitle">Beat the AI to earn points!</p>
                </div>
                <div class="difficulty-bar">
                    <button class="diff-btn easy" onclick="setDiff('easy')">üòä Easy</button>
                    <button class="diff-btn medium" onclick="setDiff('medium')">ü§î Medium</button>
                    <button class="diff-btn hard" onclick="setDiff('hard')">üòà Hard</button>
                    <button class="diff-btn master" onclick="setDiff('master')">üëë Master</button>
                    <button class="diff-btn gm active" onclick="setDiff('gm')">üèÜ GM</button>
                </div>
                <div class="mode-indicator hints-off" id="modeIndicator">üö´ No Move Hints - Pro Mode</div>
                <div class="chess-board" id="board"></div>
            </div>

            <div class="side-panel">
                <div class="ai-section">
                    <div class="ai-avatar" id="aiAvatar">üèÜ</div>
                    <div class="ai-name" id="aiName">GrandMaster AI</div>
                    <div class="ai-level" id="aiLevel">ELO 2800+</div>
                </div>
                <div class="chat-box"><p class="ai-msg" id="aiMsg">Ready to play! Make your move. ‚ôüÔ∏è</p></div>
                <div class="thinking" id="thinking"><span>Thinking</span><div class="dots"><span></span><span></span><span></span></div></div>
                <div class="turn-display white-turn" id="turnDisplay">Your Turn ‚ö™</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">You</div><div class="stat-value" id="playerMat">0</div></div>
                    <div class="stat-card"><div class="stat-label">AI</div><div class="stat-value" id="aiMat">0</div></div>
                    <div class="stat-card"><div class="stat-label">Move</div><div class="stat-value" id="moveNum">0</div></div>
                    <div class="stat-card"><div class="stat-label">Win</div><div class="stat-value" id="winPts">+20</div></div>
                </div>
                <div class="action-btns">
                    <button class="action-btn new-btn" onclick="newGame()">üîÑ New</button>
                    <button class="action-btn resign-btn" onclick="resign()">üè≥Ô∏è Resign</button>
                </div>
                <div class="captures-section">
                    <div class="captures-label">Your Captures:</div>
                    <div class="captures-pieces" id="pCaps"></div>
                    <div class="captures-label">AI Captures:</div>
                    <div class="captures-pieces" id="aCaps"></div>
                </div>
            </div>

            <div class="leaderboard">
                <div class="lb-header"><span>üèÜ</span><span class="lb-title">Leaderboard</span></div>
                <div class="lb-month" id="lbMonth">üìÖ January 2025</div>
                <div class="lb-list" id="lbList"><div class="no-data">No players yet!</div></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">Game Over!</div>
            <p class="modal-msg" id="modalMsg">Well played!</p>
            <div class="modal-points"><div class="label">Points</div><div class="value" id="modalPts">+0</div></div>
            <button class="modal-btn" onclick="newGame()">Play Again</button>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">
                <span class="copyright">¬©2026 Chess AI.</span> 
                All rights reserved. 
                <i class="fas fa-chess-king footer-icon"></i>
                <span class="author">"Subash Umasankar"</span>
            </p>
        </div>
    </footer>

    <script>
        // ========== CONSTANTS ==========
        const SYM = {'K':'‚ôî','Q':'‚ôï','R':'‚ôñ','B':'‚ôó','N':'‚ôò','P':'‚ôô','k':'‚ôö','q':'‚ôõ','r':'‚ôú','b':'‚ôù','n':'‚ôû','p':'‚ôü'};
        const VAL = {k:20000,q:900,r:500,b:330,n:320,p:100};
        const PTS = {easy:2,medium:5,hard:10,master:15,gm:20};
        
        // Optimized depths - faster but still strong
        const DEPTH = {easy:2,medium:3,hard:4,master:4,gm:5};
        const TIME_LIMIT = {easy:200,medium:400,hard:800,master:1200,gm:1500}; // ms

        // Compact PST
        const PST = {
            p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,27,27,10,5,5],[0,0,0,25,25,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-25,-25,10,10,5],[0,0,0,0,0,0,0,0]],
            n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,5,5,0,-20,-40],[-30,5,10,15,15,10,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,10,15,15,10,0,-30],[-40,-20,0,0,0,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],
            b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,5,0,0,0,0,5,-10],[-10,10,10,10,10,10,10,-10],[-10,0,10,10,10,10,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,5,10,10,5,0,-10],[-10,0,0,0,0,0,0,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],
            r:[[0,0,0,5,5,0,0,0],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[5,10,10,10,10,10,10,5],[0,0,0,0,0,0,0,0]],
            q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,5,0,0,0,0,-10],[-10,5,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,0,5,5,5,5,0,-10],[-10,0,0,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],
            k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]],
            kEnd:[[-50,-30,-30,-30,-30,-30,-30,-50],[-30,-20,-10,0,0,-10,-20,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-30,0,0,0,0,-30,-30],[-50,-30,-30,-30,-30,-30,-30,-50]]
        };

        const MSG = {
            start:["Let's play! ‚ôüÔ∏è","Ready? üéØ","Your move! üí™"],
            good:["Nice! üåü","Well played! üëè","Good one! üéØ"],
            bad:["Hmm... ü§î","Thanks! üìà","Bold! üé≠"],
            cap:["Got it! üéÅ","Mine! üòã","Thanks! ‚ôüÔ∏è"],
            lost:["Nice capture! üí™","Got me! üéØ","Well done! üëè"],
            win:["I'm winning! üèÜ","Almost there! ‚ö°"],
            lose:["You're ahead! üò∞","Good play! üåü"],
            check:["Check! üëë","Watch out! ‚ö°"],
            mate:["Checkmate! üèÜ","GG! üéâ"],
            pwin:["You win! üò±","Amazing! üèÜ"],
            draw:["Draw! ü§ù","Stalemate! ‚öñÔ∏è"],
            res:["GG! ü§ù","Next time! üëã"],
            think:["Thinking... üß†","Hmm... ü§î"],
            invalid:["Invalid! ‚ùå","Try again! üö´"],
            attack:["Attack! ‚öîÔ∏è","Here I come! üöÄ"]
        };

        // ========== STATE ==========
        let B=[],sel=null,valid=[],turn='w',diff='gm';
        let hist=[],pCaps=[],aCaps=[],moves=0,last=null,over=false;
        let cas={wK:1,wQ:1,bK:1,bQ:1},ep=null,user=null;
        let startTime=0,bestMove=null;
        let TT={},killers=[[],[]],history={};

        function showHints(){return diff==='easy'||diff==='medium';}

        // ========== AUTH ==========
        function socialLogin(p){const n=prompt(`${p} username:`);if(n&&n.trim())login(n.trim(),p);}
        function guestLogin(){const n=document.getElementById('guestName').value.trim();if(n)login(n,'guest');else alert('Enter username!');}
        
        function login(name,prov){
            resetMonth();
            let u=JSON.parse(localStorage.getItem('users')||'{}');
            const m=getMonth();
            if(!u[name])u[name]={name,prov,pts:0,w:0,l:0,d:0,m};
            if(u[name].m!==m)u[name]={...u[name],pts:0,w:0,l:0,d:0,m};
            localStorage.setItem('users',JSON.stringify(u));
            localStorage.setItem('cur',name);
            user=u[name];
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            updateUI();updateLB();newGame();
        }

        function logout(){
            localStorage.removeItem('cur');user=null;
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('gameArea').classList.add('hidden');
        }

        function getMonth(){const d=new Date();return `${d.getFullYear()}-${d.getMonth()+1}`;}
        
        function resetMonth(){
            const last=localStorage.getItem('reset'),cur=getMonth();
            if(last!==cur){
                let u=JSON.parse(localStorage.getItem('users')||'{}');
                for(let k in u)u[k]={...u[k],pts:0,w:0,l:0,d:0,m:cur};
                localStorage.setItem('users',JSON.stringify(u));
                localStorage.setItem('reset',cur);
            }
        }

        function saveResult(pts,isW,isD=false){
            if(!user)return;
            let u=JSON.parse(localStorage.getItem('users')||'{}');
            if(u[user.name]){
                u[user.name].pts+=pts;
                if(isW)u[user.name].w++;else if(isD)u[user.name].d++;else u[user.name].l++;
                localStorage.setItem('users',JSON.stringify(u));
                user=u[user.name];
                updateUI();updateLB();
            }
        }

        function updateUI(){
            if(!user)return;
            document.getElementById('userName').textContent=user.name;
            document.getElementById('userPoints').textContent=user.pts;
        }

        function updateLB(){
            const u=JSON.parse(localStorage.getItem('users')||'{}'),m=getMonth();
            const sorted=Object.values(u).filter(x=>x.m===m).sort((a,b)=>b.pts-a.pts).slice(0,12);
            const d=new Date();
            const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('lbMonth').textContent=`üìÖ ${months[d.getMonth()]} ${d.getFullYear()}`;
            const list=document.getElementById('lbList');
            if(!sorted.length){list.innerHTML='<div class="no-data">No players yet!</div>';return;}
            list.innerHTML=sorted.map((x,i)=>{
                const r=i+1,me=user&&x.name===user.name;
                const rc=r===1?'r1':r===2?'r2':r===3?'r3':'r-other';
                const ic=`lb-item ${me?'me':''} ${r===1?'gold':r===2?'silver':r===3?'bronze':''}`;
                return `<div class="${ic}"><div class="lb-rank ${rc}">${r}</div><div class="lb-info"><div class="lb-name">${x.name}</div><div class="lb-record">${x.w}W ${x.l}L ${x.d}D</div></div><div class="lb-points">${x.pts}</div></div>`;
            }).join('');
        }

        // ========== BOARD ==========
        function initB(){
            B=[['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],['','','','','','','',''],['','','','','','','',''],['','','','','','','',''],['','','','','','','',''],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']];
        }

        function render(){
            const el=document.getElementById('board');el.innerHTML='';
            const wK=findK(1),bK=findK(0),wC=inChk(1),bC=inChk(0);
            for(let r=0;r<8;r++)for(let c=0;c<8;c++){
                const sq=document.createElement('div');
                sq.className=`square ${(r+c)%2===0?'light':'dark'}`;
                if(B[r][c])sq.textContent=SYM[B[r][c]];
                if(sel&&sel.r===r&&sel.c===c)sq.classList.add('selected');
                if(showHints()&&valid.some(m=>m.r===r&&m.c===c))sq.classList.add(B[r][c]?'valid-capture':'valid-move');
                if(last&&((last.fr===r&&last.fc===c)||(last.tr===r&&last.tc===c)))sq.classList.add('last-move');
                if(wC&&wK&&wK.r===r&&wK.c===c)sq.classList.add('in-check');
                if(bC&&bK&&bK.r===r&&bK.c===c)sq.classList.add('in-check');
                sq.onclick=()=>click(r,c);
                el.appendChild(sq);
            }
        }

        function showWrongMove(r,c){
            const sq=document.querySelectorAll('.square')[r*8+c];
            if(sq){sq.classList.add('wrong-move','wrong-pulse');setMsg('invalid');setTimeout(()=>sq.classList.remove('wrong-move','wrong-pulse'),500);}
        }

        function click(r,c){
            if(turn!=='w'||over)return;
            if(sel){
                if(valid.some(m=>m.r===r&&m.c===c)){doMove(sel.r,sel.c,r,c);sel=null;valid=[];render();return;}
                const p=B[r][c];
                if(p&&isW(p)){sel={r,c};valid=getLegal(r,c);render();return;}
                if(!showHints()){showWrongMove(r,c);return;}
                sel=null;valid=[];render();return;
            }
            const p=B[r][c];
            if(p&&isW(p)){sel={r,c};valid=getLegal(r,c);render();}
        }

        // ========== PIECE LOGIC ==========
        function isW(p){return p&&p===p.toUpperCase();}
        function isB(p){return p&&p===p.toLowerCase();}
        function isE(p,w){return w?isB(p):isW(p);}
        function isA(p,w){return w?isW(p):isB(p);}
        function inB(r,c){return r>=0&&r<8&&c>=0&&c<8;}

        function getLegal(r,c){
            const p=B[r][c];if(!p)return[];
            const w=isW(p),raw=getRaw(r,c,p,w);
            return raw.filter(m=>!wouldChk(r,c,m.r,m.c,w));
        }

        function getRaw(r,c,p,w){
            const mv=[],t=p.toLowerCase();
            if(t==='p'){
                const d=w?-1:1,s=w?6:1;
                if(inB(r+d,c)&&!B[r+d][c]){mv.push({r:r+d,c});if(r===s&&!B[r+2*d][c])mv.push({r:r+2*d,c});}
                for(const dc of[-1,1]){const nc=c+dc;if(inB(r+d,nc)){if(B[r+d][nc]&&isE(B[r+d][nc],w))mv.push({r:r+d,c:nc});if(ep&&ep.r===r+d&&ep.c===nc)mv.push({r:r+d,c:nc,ep:1});}}
            }else if(t==='n'){
                for(const[dr,dc]of[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]){const nr=r+dr,nc=c+dc;if(inB(nr,nc)&&!isA(B[nr][nc],w))mv.push({r:nr,c:nc});}
            }else if(t==='b')slide(r,c,w,[[1,1],[1,-1],[-1,1],[-1,-1]],mv);
            else if(t==='r')slide(r,c,w,[[0,1],[0,-1],[1,0],[-1,0]],mv);
            else if(t==='q')slide(r,c,w,[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]],mv);
            else if(t==='k'){
                for(const[dr,dc]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]){const nr=r+dr,nc=c+dc;if(inB(nr,nc)&&!isA(B[nr][nc],w))mv.push({r:nr,c:nc});}
                if(w){if(cas.wK&&!B[7][5]&&!B[7][6]&&B[7][7]==='R'&&!atk(7,4,0)&&!atk(7,5,0)&&!atk(7,6,0))mv.push({r:7,c:6,cK:1});if(cas.wQ&&!B[7][1]&&!B[7][2]&&!B[7][3]&&B[7][0]==='R'&&!atk(7,4,0)&&!atk(7,3,0)&&!atk(7,2,0))mv.push({r:7,c:2,cQ:1});}
                else{if(cas.bK&&!B[0][5]&&!B[0][6]&&B[0][7]==='r'&&!atk(0,4,1)&&!atk(0,5,1)&&!atk(0,6,1))mv.push({r:0,c:6,cK:1});if(cas.bQ&&!B[0][1]&&!B[0][2]&&!B[0][3]&&B[0][0]==='r'&&!atk(0,4,1)&&!atk(0,3,1)&&!atk(0,2,1))mv.push({r:0,c:2,cQ:1});}
            }
            return mv;
        }

        function slide(r,c,w,dirs,mv){
            for(const[dr,dc]of dirs){for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!inB(nr,nc))break;const t=B[nr][nc];if(!t)mv.push({r:nr,c:nc});else{if(isE(t,w))mv.push({r:nr,c:nc});break;}}}
        }

        function atk(r,c,byW){
            const pd=byW?1:-1,pn=byW?'P':'p';
            if(inB(r+pd,c-1)&&B[r+pd][c-1]===pn)return 1;
            if(inB(r+pd,c+1)&&B[r+pd][c+1]===pn)return 1;
            const kn=byW?'N':'n';
            for(const[dr,dc]of[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]])if(inB(r+dr,c+dc)&&B[r+dr][c+dc]===kn)return 1;
            const kg=byW?'K':'k';
            for(const[dr,dc]of[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]])if(inB(r+dr,c+dc)&&B[r+dr][c+dc]===kg)return 1;
            const rk=byW?'R':'r',qn=byW?'Q':'q';
            for(const[dr,dc]of[[0,1],[0,-1],[1,0],[-1,0]]){for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!inB(nr,nc))break;const p=B[nr][nc];if(p){if(p===rk||p===qn)return 1;break;}}}
            const bs=byW?'B':'b';
            for(const[dr,dc]of[[1,1],[1,-1],[-1,1],[-1,-1]]){for(let i=1;i<8;i++){const nr=r+dr*i,nc=c+dc*i;if(!inB(nr,nc))break;const p=B[nr][nc];if(p){if(p===bs||p===qn)return 1;break;}}}
            return 0;
        }

        function findK(w){const k=w?'K':'k';for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(B[r][c]===k)return{r,c};return null;}
        function inChk(w){const k=findK(w);return k&&atk(k.r,k.c,!w);}
        function wouldChk(fr,fc,tr,tc,w){const orig=B[tr][tc],pc=B[fr][fc];B[tr][tc]=pc;B[fr][fc]='';const chk=inChk(w);B[fr][fc]=pc;B[tr][tc]=orig;return chk;}
        function hasLegal(w){for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=B[r][c];if(p&&(w?isW(p):isB(p))&&getLegal(r,c).length)return 1;}return 0;}

        // ========== MOVE ==========
        function doMove(fr,fc,tr,tc,ai=0){
            const pc=B[fr][fc],cap=B[tr][tc],w=isW(pc);
            const mv=valid.find(m=>m.r===tr&&m.c===tc)||{};
            hist.push({fr,fc,tr,tc,pc,cap,cas:{...cas},ep});
            if(cap){if(w)pCaps.push(cap);else aCaps.push(cap);}
            if(mv.ep){const cr=w?tr+1:tr-1;if(w)pCaps.push(B[cr][tc]);else aCaps.push(B[cr][tc]);B[cr][tc]='';}
            if(mv.cK){B[tr][5]=B[tr][7];B[tr][7]='';}
            if(mv.cQ){B[tr][3]=B[tr][0];B[tr][0]='';}
            ep=null;if(pc.toLowerCase()==='p'&&Math.abs(tr-fr)===2)ep={r:(fr+tr)/2,c:fc};
            if(pc==='K'){cas.wK=0;cas.wQ=0;}if(pc==='k'){cas.bK=0;cas.bQ=0;}
            if(fr===7&&fc===0)cas.wQ=0;if(fr===7&&fc===7)cas.wK=0;
            if(fr===0&&fc===0)cas.bQ=0;if(fr===0&&fc===7)cas.bK=0;
            B[tr][tc]=pc;B[fr][fc]='';
            if(pc.toLowerCase()==='p'&&(tr===0||tr===7))B[tr][tc]=w?'Q':'q';
            last={fr,fc,tr,tc};moves++;
            updateStats();
            const oW=!w,oChk=inChk(oW),oMv=hasLegal(oW);
            if(oChk&&!oMv){over=1;render();setTimeout(()=>{if(w){saveResult(PTS[diff],1);showModal('You Win! üèÜ',rnd(MSG.pwin),PTS[diff]);}else{saveResult(0,0);showModal('Checkmate!',rnd(MSG.mate),0);}},300);return;}
            if(!oMv){over=1;render();setTimeout(()=>{saveResult(1,0,1);showModal('Stalemate!',rnd(MSG.draw),1);},300);return;}
            if(oChk)setMsg('check');
            turn=turn==='w'?'b':'w';updateTurn();
            if(!ai&&!oChk){if(cap)setMsg('lost');else{const ev=evaluate();if(ev>200)setMsg('lose');else if(ev<-200)setMsg('win');else if(Math.random()>0.6)setMsg(Math.random()>0.5?'good':'bad');}}
            else if(ai&&cap)setMsg('cap');
            if(turn==='b'&&!over)setTimeout(aiMove,50);
        }

        // ========== FAST AI ENGINE ==========
        function aiMove(){
            document.getElementById('thinking').classList.add('active');
            setMsg('think');
            setTimeout(()=>{
                TT={};killers=[[],[]];history={};
                startTime=Date.now();bestMove=null;
                const mvs=genMoves(0);
                if(mvs.length===0){document.getElementById('thinking').classList.remove('active');return;}
                if(mvs.length===1){bestMove=mvs[0];}
                else{
                    // Iterative deepening with time limit
                    for(let d=1;d<=DEPTH[diff];d++){
                        if(Date.now()-startTime>TIME_LIMIT[diff]*0.8)break;
                        search(d,-99999,99999,0);
                    }
                }
                if(bestMove){sel={r:bestMove.fr,c:bestMove.fc};valid=getLegal(bestMove.fr,bestMove.fc);doMove(bestMove.fr,bestMove.fc,bestMove.tr,bestMove.tc,1);}
                sel=null;valid=[];
                document.getElementById('thinking').classList.remove('active');
                render();
            },30);
        }

        function search(depth,alpha,beta,ply){
            if(Date.now()-startTime>TIME_LIMIT[diff])return alpha;
            const hash=getHash();
            if(TT[hash]&&TT[hash].d>=depth){
                const e=TT[hash];
                if(e.f==='e')return e.v;
                if(e.f==='l')alpha=Math.max(alpha,e.v);
                if(e.f==='u')beta=Math.min(beta,e.v);
                if(alpha>=beta)return e.v;
            }
            if(depth<=0)return quiesce(alpha,beta);
            const isBlack=turn==='b';
            const inCheck=inChk(!isBlack);
            if(inCheck)depth++;
            const mvs=genMoves(isBlack?0:1);
            if(!mvs.length)return inCheck?-20000+ply:0;
            orderMoves(mvs,ply);
            let bestVal=-99999,flag='u',localBest=null;
            for(let i=0;i<mvs.length;i++){
                if(Date.now()-startTime>TIME_LIMIT[diff])break;
                const m=mvs[i];
                const s=saveState();
                makeMove(m);
                turn=turn==='w'?'b':'w';
                let v;
                if(i>=4&&depth>=3&&!m.cap&&!inCheck){
                    v=-search(depth-2,-beta,-alpha,ply+1);
                    if(v>alpha)v=-search(depth-1,-beta,-alpha,ply+1);
                }else{
                    v=-search(depth-1,-beta,-alpha,ply+1);
                }
                turn=turn==='w'?'b':'w';
                restoreState(s);
                if(v>bestVal){bestVal=v;localBest=m;}
                if(v>alpha){alpha=v;flag='e';}
                if(v>=beta){
                    if(!m.cap&&ply<2){killers[ply].unshift(m);if(killers[ply].length>2)killers[ply].pop();}
                    const key=m.fr*1000+m.fc*100+m.tr*10+m.tc;
                    history[key]=(history[key]||0)+depth*depth;
                    TT[hash]={v:beta,d:depth,f:'l'};
                    return beta;
                }
            }
            TT[hash]={v:bestVal,d:depth,f:flag};
            if(ply===0&&localBest)bestMove=localBest;
            return alpha;
        }

        function quiesce(alpha,beta){
            const stand=evaluate();
            if(stand>=beta)return beta;
            if(stand>alpha)alpha=stand;
            const isBlack=turn==='b';
            const caps=genMoves(isBlack?0:1).filter(m=>m.cap);
            orderMoves(caps,99);
            for(const m of caps){
                if(Date.now()-startTime>TIME_LIMIT[diff])break;
                const s=saveState();
                makeMove(m);
                turn=turn==='w'?'b':'w';
                const v=-quiesce(-beta,-alpha);
                turn=turn==='w'?'b':'w';
                restoreState(s);
                if(v>=beta)return beta;
                if(v>alpha)alpha=v;
            }
            return alpha;
        }

        function genMoves(forWhite){
            const mvs=[];
            for(let r=0;r<8;r++){
                for(let c=0;c<8;c++){
                    const p=B[r][c];
                    if(!p)continue;
                    if(forWhite?!isW(p):isW(p))continue;
                    const legal=getLegal(r,c);
                    for(const m of legal){
                        mvs.push({fr:r,fc:c,tr:m.r,tc:m.c,cap:B[m.r][m.c],pc:p,cK:m.cK,cQ:m.cQ,ep:m.ep});
                    }
                }
            }
            return mvs;
        }

        function orderMoves(mvs,ply){
            for(const m of mvs){
                m.score=0;
                // Captures - MVV-LVA
                if(m.cap){
                    m.score=10000+VAL[m.cap.toLowerCase()]*10-VAL[m.pc.toLowerCase()];
                }
                // Promotions
                if(m.pc.toLowerCase()==='p'&&(m.tr===0||m.tr===7))m.score+=9000;
                // Killer moves
                if(ply<2&&killers[ply]){
                    for(let i=0;i<killers[ply].length;i++){
                        const k=killers[ply][i];
                        if(k&&k.fr===m.fr&&k.fc===m.fc&&k.tr===m.tr&&k.tc===m.tc){
                            m.score+=5000-i*100;break;
                        }
                    }
                }
                // History
                const key=m.fr*1000+m.fc*100+m.tr*10+m.tc;
                m.score+=(history[key]||0);
                // Center control
                if(m.tr>=2&&m.tr<=5&&m.tc>=2&&m.tc<=5)m.score+=20;
            }
            mvs.sort((a,b)=>b.score-a.score);
        }

        function makeMove(m){
            if(m.ep){const cr=isW(m.pc)?m.tr+1:m.tr-1;B[cr][m.tc]='';}
            if(m.cK){B[m.tr][5]=B[m.tr][7];B[m.tr][7]='';}
            if(m.cQ){B[m.tr][3]=B[m.tr][0];B[m.tr][0]='';}
            B[m.tr][m.tc]=m.pc;B[m.fr][m.fc]='';
            if(m.pc.toLowerCase()==='p'&&(m.tr===0||m.tr===7))B[m.tr][m.tc]=isW(m.pc)?'Q':'q';
            if(m.pc==='K'){cas.wK=0;cas.wQ=0;}if(m.pc==='k'){cas.bK=0;cas.bQ=0;}
            if(m.fr===7&&m.fc===0)cas.wQ=0;if(m.fr===7&&m.fc===7)cas.wK=0;
            if(m.fr===0&&m.fc===0)cas.bQ=0;if(m.fr===0&&m.fc===7)cas.bK=0;
            if(m.pc.toLowerCase()==='p'&&Math.abs(m.tr-m.fr)===2)ep={r:(m.fr+m.tr)/2,c:m.fc};else ep=null;
        }

        function saveState(){return{B:B.map(r=>[...r]),cas:{...cas},ep:ep?{...ep}:null};}
        function restoreState(s){B=s.B;cas=s.cas;ep=s.ep;}
        function getHash(){let h='';for(let r=0;r<8;r++)for(let c=0;c<8;c++)h+=B[r][c]||'.';return h+turn+(cas.wK?1:0)+(cas.wQ?1:0)+(cas.bK?1:0)+(cas.bQ?1:0);}

        function evaluate(){
            let sc=0,wMat=0,bMat=0;
            for(let r=0;r<8;r++){
                for(let c=0;c<8;c++){
                    const p=B[r][c];if(!p)continue;
                    const w=isW(p),t=p.toLowerCase(),v=VAL[t];
                    if(w)wMat+=v;else bMat+=v;
                    const pr=w?r:7-r;
                    let pst=PST[t]?PST[t][pr][c]:0;
                    if(t==='k'&&(wMat+bMat)<2500)pst=PST.kEnd[pr][c];
                    if(w)sc+=v+pst;else sc-=v+pst;
                }
            }
            // Mobility (simplified)
            const wMob=genMoves(1).length,bMob=genMoves(0).length;
            sc+=(wMob-bMob)*4;
            // Bonus for captures available (aggression)
            const caps=genMoves(0).filter(m=>m.cap);
            sc-=caps.length*15;
            return turn==='w'?sc:-sc;
        }

        // ========== CONTROLS ==========
        function updateModeIndicator(){
            const ind=document.getElementById('modeIndicator');
            if(showHints()){ind.className='mode-indicator hints-on';ind.textContent='‚úÖ Move Hints Enabled';}
            else{ind.className='mode-indicator hints-off';ind.textContent='üö´ No Move Hints - Pro Mode';}
        }

        function setDiff(d){
            diff=d;
            document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
            document.querySelector(`.diff-btn.${d}`).classList.add('active');
            const nm={easy:'Beginner',medium:'Club Player',hard:'Expert',master:'Master',gm:'GrandMaster'};
            const lv={easy:'ELO 800',medium:'ELO 1400',hard:'ELO 2000',master:'ELO 2400',gm:'ELO 2800+'};
            const av={easy:'ü§ñ',medium:'üß†',hard:'üíª',master:'üëë',gm:'üèÜ'};
            document.getElementById('aiName').textContent=nm[d]+' AI';
            document.getElementById('aiLevel').textContent=lv[d];
            document.getElementById('aiAvatar').textContent=av[d];
            document.getElementById('winPts').textContent='+'+PTS[d];
            updateModeIndicator();newGame();
        }

        function resign(){
            if(over||moves===0)return;
            if(confirm('Resign?')){over=1;saveResult(0,0);showModal('Resigned',rnd(MSG.res),0);}
        }

        function newGame(){
            document.getElementById('modal').classList.remove('active');
            initB();sel=null;valid=[];turn='w';
            hist=[];pCaps=[];aCaps=[];moves=0;last=null;over=0;
            ep=null;cas={wK:1,wQ:1,bK:1,bQ:1};
            TT={};killers=[[],[]];history={};bestMove=null;
            updateStats();updateTurn();setMsg('start');updateModeIndicator();render();
        }

        function updateStats(){
            document.getElementById('moveNum').textContent=Math.ceil(moves/2);
            document.getElementById('playerMat').textContent=calcMat(pCaps);
            document.getElementById('aiMat').textContent=calcMat(aCaps);
            document.getElementById('pCaps').textContent=pCaps.map(p=>SYM[p]).join('');
            document.getElementById('aCaps').textContent=aCaps.map(p=>SYM[p]).join('');
        }

        function calcMat(caps){return caps.reduce((s,p)=>s+(VAL[p.toLowerCase()]||0),0);}

        function updateTurn(){
            const el=document.getElementById('turnDisplay');
            el.textContent=turn==='w'?'Your Turn ‚ö™':'AI Thinking ‚ö´';
            el.className=`turn-display ${turn==='w'?'white-turn':'black-turn'}`;
        }

        function rnd(arr){return arr[Math.floor(Math.random()*arr.length)];}
        function setMsg(t){document.getElementById('aiMsg').textContent=rnd(MSG[t]);}
        function showModal(title,msg,pts){
            document.getElementById('modalTitle').textContent=title;
            document.getElementById('modalMsg').textContent=msg;
            document.getElementById('modalPts').textContent='+'+pts;
            document.getElementById('modal').classList.add('active');
        }

        // ========== INIT ==========
        function init(){
            resetMonth();
            const saved=localStorage.getItem('cur');
            if(saved){
                const u=JSON.parse(localStorage.getItem('users')||'{}');
                if(u[saved]){
                    user=u[saved];
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('gameArea').classList.remove('hidden');
                    updateUI();updateLB();setDiff('gm');return;
                }
            }
            document.getElementById('guestName').addEventListener('keypress',e=>{if(e.key==='Enter')guestLogin();});
        }
        init();
    </script>
</body>
</html>
